<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìƒì„¸</title>
</head>
<body>
<h2>ê²Œì‹œê¸€ ìƒì„¸</h2>
<div id="detailView"></div>
<br>
<div id="editDeleteBtn" style="display:none;">
    <button onclick="showEdit()">[ìˆ˜ì •]</button>
    <button onclick="deletePost()">[ì‚­ì œ]</button>
</div>
<a href="/posts">ëª©ë¡</a>

<div id="editForm" style="display:none">
    <input type="text" id="editTitle"><br><br>
    <textarea id="editContent" rows="5" cols="50"></textarea><br><br>
    <button onclick="submitEdit()">ìˆ˜ì • ì™„ë£Œ</button>
</div>

<script>
    // ğŸ” ë¡œê·¸ì¸ í† í° í™•ì¸
    const token = localStorage.getItem("jwt");
    if (!token) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/login";
    }

    // âœ… ê²Œì‹œê¸€ IDë¥¼ URL ê²½ë¡œì—ì„œ ì¶”ì¶œ (/posts/3 â†’ 3)
    const pathParts = window.location.pathname.split('/');
    const postId = pathParts[pathParts.length - 1];

    let postWriterId = null;
    let currentUserId = null;

    async function loadPost() {
        const res = await fetch(`/api/post/${postId}`);
        if (!res.ok) {
            alert("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            return;
        }

        const post = await res.json();
        postWriterId = post.writerId;

        const view = document.getElementById("detailView");
        view.innerHTML = `<h3>${post.title}</h3><p>${post.content}</p>`;
        document.getElementById("editTitle").value = post.title;
        document.getElementById("editContent").value = post.content;

        const infoRes = await fetch('/api/user/info', {
            headers: {
                Authorization: 'Bearer ' + token
            }
        });
        console.log(infoRes)
        if (infoRes.ok) {
            const user = await infoRes.json();
            currentUserId = user.id;

            console.log("ğŸ” user info:", user); // ì—¬ê¸°ì— idê°€ ë“¤ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤
            console.log("ğŸ” currentUserId:", currentUserId);
            console.log("ğŸ” postWriterId:", postWriterId);
            console.log("ğŸ” ë¹„êµ ê²°ê³¼:", currentUserId === postWriterId);

            if (Number(currentUserId) === Number(postWriterId)) {
                document.getElementById("editDeleteBtn").style.display = "block";
            }

        }
    }

    function showEdit() {
        document.getElementById("editForm").style.display = "block";
    }

    async function submitEdit() {
        const title = document.getElementById("editTitle").value;
        const content = document.getElementById("editContent").value;

        console.log("ìˆ˜ì • ìš”ì²­", { title, content, postId });

        const res = await fetch(`/api/post/${postId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ title, content })  // âœ… ì´ êµ¬ì¡°ëŠ” ë§ìŒ
        });

        if (res.ok) {
            alert("ìˆ˜ì • ì™„ë£Œ");
            location.reload();
        } else {
            const errorText = await res.text();
            console.error("ìˆ˜ì • ì‹¤íŒ¨:", errorText);
            alert("ìˆ˜ì • ì‹¤íŒ¨");
        }
    }


    async function deletePost() {
        const confirmed = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if (!confirmed) return;

        const res = await fetch(`/api/post/${postId}`, {
            method: "DELETE",
            headers: {
                "Authorization": "Bearer " + token
            }
        });

        if (res.ok) {
            alert("ì‚­ì œ ì™„ë£Œ");
            window.location.href = "/posts";
        } else {
            alert("ì‚­ì œ ì‹¤íŒ¨");
        }
    }

    loadPost();
</script>
</body>
</html>
